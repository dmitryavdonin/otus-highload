# Настройка репликации PostgreSQL (1 мастер, 2 слейва) для Windows с миграцией существующих данных

В этом документе описаны шаги для настройки потоковой репликации PostgreSQL с одним мастером и двумя слейвами с использованием Docker Compose на Windows, включая миграцию существующих данных.

## Архитектура

- **db-master** (порт 5432): Мастер-сервер PostgreSQL (чтение и запись)
- **db-slave1** (порт 5433): Первый слейв-сервер PostgreSQL (только чтение)
- **db-slave2** (порт 5434): Второй слейв-сервер PostgreSQL (только чтение)
- **app**: Приложение FastAPI, подключенное к мастеру

## Запуск репликации с миграцией существующих данных

1. Запустите новую конфигурацию с репликацией (сохраняя существующие данные мастера):
   ```cmd
   start-replication.bat
   ```

2. Дождитесь инициализации всех контейнеров (это может занять некоторое время).

3. Запустите скрипт для миграции существующих данных и настройки репликации:
   ```cmd
   migrate-data-simple.bat
   ```
   
   Или используйте более сложный скрипт с pg_basebackup:
   ```cmd
   migrate-existing-data.bat
   ```

## Проверка репликации

1. Проверьте статус репликации:
   ```cmd
   docker exec postgres-master psql -U postgres -c "SELECT * FROM pg_stat_replication;"
   ```

2. Проверьте задержку репликации:
   ```cmd
   check-replication-lag.bat
   ```

3. Тестирование репликации:
   ```cmd
   test-replication.bat
   ```
   
   Или выполните команды вручную:
   - Вставьте данные на мастере:
     ```cmd
     docker exec postgres-master psql -U postgres -d social_network -c "INSERT INTO replication_test (test_data) VALUES ('New test data');"
     ```
   - Проверьте, что данные реплицировались на слейвы:
     ```cmd
     docker exec postgres-slave1 psql -U postgres -d social_network -c "SELECT * FROM replication_test ORDER BY id DESC LIMIT 5;"
     docker exec postgres-slave2 psql -U postgres -d social_network -c "SELECT * FROM replication_test ORDER BY id DESC LIMIT 5;"
     ```

## Подключение к базам данных

Для подключения через psql в Windows вы можете использовать:

- Мастер: `docker exec -it postgres-master psql -U postgres -d social_network`
- Слейв 1: `docker exec -it postgres-slave1 psql -U postgres -d social_network`
- Слейв 2: `docker exec -it postgres-slave2 psql -U postgres -d social_network`

Или, если у вас установлен PostgreSQL клиент локально:

- Мастер: `psql -h localhost -p 5432 -U postgres -d social_network`
- Слейв 1: `psql -h localhost -p 5433 -U postgres -d social_network`
- Слейв 2: `psql -h localhost -p 5434 -U postgres -d social_network`

## Особенности

- Слейвы работают в режиме только для чтения
- Все изменения данных должны выполняться на мастере
- Данные автоматически реплицируются с мастера на слейвы

## Миграция существующих данных

Для миграции существующих данных из мастера в слейвы предусмотрено два подхода:

### Подход 1: Использование pg_dump/pg_restore (migrate-data-simple.bat)

Этот подход включает:
1. Создание дампа базы данных на мастере с помощью pg_dump
2. Копирование дампа на слейвы
3. Восстановление данных на слейвах
4. Настройка репликации для синхронизации последующих изменений

Преимущества:
- Простота реализации
- Меньше требований к настройкам мастера
- Работает даже при больших объемах данных

Недостатки:
- Временная несогласованность данных во время миграции
- Требуется дополнительное дисковое пространство для дампа

### Подход 2: Использование pg_basebackup (migrate-existing-data.bat)

Этот подход включает:
1. Настройку мастера для поддержки репликации
2. Создание пользователя для репликации
3. Использование pg_basebackup для копирования всех данных и настроек
4. Автоматическую настройку репликации

Преимущества:
- Полная согласованность данных
- Автоматическая настройка репликации
- Копирование всех объектов базы данных

Недостатки:
- Более сложная реализация
- Требуется правильная настройка мастера
- Может занять больше времени при больших объемах данных

## Возможные проблемы и их решения

1. **Проблемы с подключением**:
   - Проверьте, что все контейнеры запущены: `docker ps`
   - Проверьте логи контейнеров: `docker logs postgres-master`
   - Если Docker использует WSL2, проверьте настройки WSL и доступность портов

2. **Проблемы с репликацией**:
   - Проверьте настройки pg_hba.conf
   - Проверьте логи PostgreSQL: `docker exec postgres-master cat /var/log/postgresql/postgresql-*.log`
   - Проверьте, что Docker имеет достаточно ресурсов (память, CPU)

3. **Задержка репликации**:
   - Увеличьте значение wal_keep_size в postgresql.conf
   - Проверьте нагрузку на диски и сеть
   - В Windows с WSL2 производительность дисков может быть ниже, чем в Linux

4. **Проблемы с файловыми путями в Windows**:
   - Используйте формат пути Docker (с прямыми слешами) внутри контейнеров
   - При копировании файлов в контейнер убедитесь, что они имеют правильные окончания строк (LF, а не CRLF)

5. **Проблемы с миграцией данных**:
   - При ошибке "permission denied" проверьте права доступа к файлам
   - При ошибке "could not connect to server" проверьте настройки pg_hba.conf
   - При больших объемах данных увеличьте таймауты в скриптах
