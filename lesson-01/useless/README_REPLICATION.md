# Настройка кворумной синхронной репликации PostgreSQL

В этом проекте представлены два варианта настройки кворумной синхронной репликации PostgreSQL:
1. Нативная синхронная репликация PostgreSQL
2. Кластер PostgreSQL с использованием Patroni

## 1. Нативная синхронная репликация PostgreSQL

### 1.1. Запуск кластера

```bash
# Сделать скрипты исполняемыми
chmod +x init-master-sync.sh init-slave-sync.sh test_sync_replication.sh

# Запустить кластер
docker-compose -f docker-compose-sync-replication.yml up -d
```

### 1.2. Проверка работы репликации

```bash
# Запустить тестовый скрипт
./test_sync_replication.sh
```

### 1.3. Остановка кластера

```bash
docker-compose -f docker-compose-sync-replication.yml down
```

## 2. Кластер PostgreSQL с Patroni

### 2.1. Запуск кластера

```bash
# Сделать скрипт тестирования исполняемым
chmod +x test_patroni.sh

# Запустить кластер
docker-compose -f docker-compose-patroni.yml up -d
```

### 2.2. Проверка работы кластера

```bash
# Запустить тестовый скрипт
./test_patroni.sh
```

### 2.3. Остановка кластера

```bash
docker-compose -f docker-compose-patroni.yml down
```

## 3. Документация

В проекте доступны следующие документы:
- `quorum_sync_replication_guide.md` - руководство по настройке нативной кворумной синхронной репликации
- `patroni_guide.md` - руководство по настройке кластера PostgreSQL с Patroni

## 4. Особенности реализации

### 4.1. Нативная синхронная репликация

- Настроена кворумная синхронная репликация с требованием подтверждения от 2 из 3 слейвов
- Транзакции подтверждаются только после записи на мастер и как минимум 2 слейва
- Система продолжает работать даже при отказе одного из слейвов

### 4.2. Кластер с Patroni

- Автоматическое переключение при сбое (failover)
- Автоматическое восстановление (failback)
- Синхронная репликация с настраиваемым количеством узлов
- Балансировка нагрузки через HAProxy
- Мониторинг через REST API

## 5. Рекомендации по выбору решения

### 5.1. Нативная синхронная репликация

**Преимущества:**
- Простота настройки
- Нет дополнительных зависимостей
- Меньше потребление ресурсов

**Недостатки:**
- Ручное переключение при сбое мастера
- Ограниченные возможности мониторинга
- Сложнее автоматизировать управление кластером

### 5.2. Кластер с Patroni

**Преимущества:**
- Автоматическое переключение при сбое
- Удобный REST API для управления и мониторинга
- Интеграция с системами обнаружения сервисов
- Гибкая настройка репликации

**Недостатки:**
- Более сложная архитектура
- Дополнительные зависимости (etcd)
- Больше потребление ресурсов

## 6. Заключение

Оба решения обеспечивают высокую надежность данных через кворумную синхронную репликацию. Выбор между ними зависит от конкретных требований проекта:

- Для небольших проектов с ограниченными ресурсами подойдет нативная синхронная репликация
- Для крупных проектов с высокими требованиями к отказоустойчивости рекомендуется использовать Patroni
