<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Домашнее задание №9. Отчет по отказоустойчивости приложений</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        h1 {
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            margin-top: 30px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            overflow-x: auto;
        }
        code {
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            background-color: #f8f8f8;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .highlight {
            background-color: #ffffcc;
            padding: 2px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .note {
            background-color: #e7f3fe;
            border-left: 6px solid #2196F3;
            padding: 10px;
            margin: 15px 0;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 6px solid #ffc107;
            padding: 10px;
            margin: 15px 0;
        }
        .success {
            background-color: #d4edda;
            border-left: 6px solid #28a745;
            padding: 10px;
            margin: 15px 0;
        }
        img {
            max-width: 100%;
            height: auto;
        }
        .architecture-diagram {
            text-align: center;
            margin: 20px 0;
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        .comparison-table {
            margin: 20px 0;
        }
        .improvement {
            font-weight: bold;
        }
        .improvement.positive {
            color: #28a745;
        }
        .improvement.negative {
            color: #dc3545;
        }
        .step {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                fontFamily: 'Arial, sans-serif',
                fontSize: '14px'
            }
        });
    </script>
</head>
<body>
    <h1>OTUS. Highload Architecture</h1>
    <h2>ДЗ № 9 - Отказоустойчивость приложений</h2>
    <h3>Авдонин Дмитрий</h3>

    <h2>Задача</h2>
    <p>Уменьшить число точек отказа в приложении путём настройки отказоустойчивой архитектуры:</p>
    <ul>
        <li>Поднять несколько слейвов PostgreSQL</li>
        <li>Реализовать соединение со слейвами PostgreSQL через HAProxy</li>
        <li>Поднять несколько приложений и обеспечить их балансировку через nginx</li>
        <li>Воспроизвести нагрузку</li>
        <li>Протестировать отказоустойчивость при kill -9 слейва и инстанса бэкенда</li>
    </ul>

    <h2>Архитектура решения</h2>
    
    <h3>Общая архитектура системы</h3>
    <div class="architecture-diagram">
        <div class="mermaid">
graph TB
    subgraph "Клиентский уровень"
        Client[Клиенты<br/>HTTP Requests]
    end

    subgraph "Балансировка HTTP"
        Nginx[Nginx Load Balancer<br/>Port 80<br/>least_conn algorithm]
    end

    subgraph "Уровень приложений"
        App1[FastAPI App1<br/>Port 9001]
        App2[FastAPI App2<br/>Port 9002]
        App3[FastAPI App3<br/>Port 9003]
    end

    subgraph "Балансировка TCP"
        HAProxy[HAProxy TCP Proxy<br/>Stats: Port 8404]
        WritePort[Write Port 5000<br/>→ Master Only]
        ReadPort[Read Port 5001<br/>→ Round Robin Slaves]
    end

    subgraph "Уровень данных"
        Master[PostgreSQL Master<br/>Port 5432<br/>Write Operations]
        Slave1[PostgreSQL Slave1<br/>Port 5433<br/>Read Replica]
        Slave2[PostgreSQL Slave2<br/>Port 5434<br/>Read Replica]
    end

    subgraph "Кэширование"
        Redis[Redis Cache<br/>Port 6379]
    end

    %% Основные связи
    Client --> Nginx
    Nginx --> App1
    Nginx --> App2
    Nginx --> App3

    App1 --> WritePort
    App1 --> ReadPort
    App2 --> WritePort
    App2 --> ReadPort
    App3 --> WritePort
    App3 --> ReadPort

    WritePort --> Master
    ReadPort --> Slave1
    ReadPort --> Slave2

    %% Репликация
    Master -.->|Streaming Replication| Slave1
    Master -.->|Streaming Replication| Slave2

    %% Кэш
    App1 --> Redis
    App2 --> Redis
    App3 --> Redis

    %% Health checks
    HAProxy -.->|TCP Health Check| Master
    HAProxy -.->|TCP Health Check| Slave1
    HAProxy -.->|TCP Health Check| Slave2
    Nginx -.->|HTTP Health Check| App1
    Nginx -.->|HTTP Health Check| App2
    Nginx -.->|HTTP Health Check| App3

    classDef client fill:#e1f5fe
    classDef nginx fill:#fff3e0
    classDef app fill:#f3e5f5
    classDef haproxy fill:#e8f5e8
    classDef database fill:#fff8e1
    classDef redis fill:#ffebee

    class Client client
    class Nginx nginx
    class App1,App2,App3 app
    class HAProxy,WritePort,ReadPort haproxy
    class Master,Slave1,Slave2 database
    class Redis redis
        </div>
    </div>



    <h3>Компоненты системы</h3>
    <table>
        <tr>
            <th>Компонент</th>
            <th>Количество</th>
            <th>Порты</th>
            <th>Назначение</th>
        </tr>
        <tr>
            <td>PostgreSQL Master</td>
            <td>1</td>
            <td>5432</td>
            <td>Запись данных</td>
        </tr>
        <tr>
            <td>PostgreSQL Slaves</td>
            <td>2</td>
            <td>5433, 5434</td>
            <td>Чтение данных</td>
        </tr>
        <tr>
            <td>HAProxy</td>
            <td>1</td>
            <td>5000 (master), 5001 (slaves), 8404 (stats)</td>
            <td>Балансировка PostgreSQL</td>
        </tr>
        <tr>
            <td>FastAPI приложения</td>
            <td>3</td>
            <td>9001, 9002, 9003</td>
            <td>Обработка запросов</td>
        </tr>
        <tr>
            <td>nginx</td>
            <td>1</td>
            <td>80</td>
            <td>Балансировка приложений</td>
        </tr>
        <tr>
            <td>Redis</td>
            <td>1</td>
            <td>6379</td>
            <td>Кэширование</td>
        </tr>
    </table>

    <h2>Структура проекта</h2>
    
    <div class="note">
        Все файлы размещены в директории <code>lesson-09/</code>
    </div>
    
    <h3>Основные файлы конфигурации:</h3>
    <ul>
        <li><strong>docker-compose-ha.yml</strong> - основной файл оркестрации всех сервисов</li>
        <li><strong>haproxy.cfg</strong> - конфигурация HAProxy для балансировки PostgreSQL</li>
        <li><strong>nginx-ha.conf</strong> - конфигурация Nginx для балансировки приложений</li>
        <li><strong>schema.sql</strong> - схема базы данных с полным набором таблиц</li>
        <li><strong>database_ha.py</strong> - модуль для работы с HAProxy подключениями</li>
        <li><strong>pg_hba.conf</strong> - настройки аутентификации PostgreSQL</li>
        <li><strong>init-master.sh, init-slave.sh</strong> - скрипты инициализации репликации</li>
    </ul>

    <h3>Скрипты автоматизации:</h3>
    <ul>
        <li><strong>start_service.sh</strong> - автоматический запуск всей системы с проверками</li>
        <li><strong>test_service.sh</strong> - автоматическое выполнение всех тестов подряд с таймаутами</li>
        <li><strong>stop_service.sh</strong> - полная очистка системы с подтверждением</li>
        <li><strong>failover_test.sh</strong> - автоматизированное тестирование отказоустойчивости</li>
    </ul>

    <h3>Тестирование и логирование:</h3>
    <ul>
        <li><strong>load_test.py</strong> - базовые нагрузочные тесты с retry логикой</li>
        <li><strong>final_test_with_logs.py</strong> - детальное тестирование с логированием в файл</li>
        <li><strong>system_logs_for_report.txt</strong> - сводка системных логов для отчета</li>
        <li><strong>test_results.log</strong> - автоматически создаваемые логи тестирования</li>
        <li><strong>architecture_diagram.md</strong> - исходный код архитектурной диаграммы</li>
    </ul>

    <h2>Реализация</h2>

    <h3>Конфигурация HAProxy</h3>
    <div class="note">
        <strong>Настройки балансировки PostgreSQL:</strong>
        <ul>
            <li><strong>Frontend postgres_write</strong>: порт 5000 → мастер (запись)</li>
            <li><strong>Frontend postgres_read</strong>: порт 5001 → слейвы (чтение, round-robin)</li>
            <li><strong>Health checks</strong>: TCP-check каждые 5 секунд</li>
            <li><strong>Статистика</strong>: http://localhost:8404/stats</li>
        </ul>
    </div>
<pre><code>global
    daemon
    log stdout local0

defaults
    mode tcp
    timeout connect 10s
    timeout client 600s
    timeout server 600s
    timeout tunnel 600s
    timeout check 5s
    option tcplog
    log global

frontend stats
    mode http
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s

frontend postgres_write
    bind *:5000
    default_backend postgres_master

frontend postgres_read
    bind *:5001
    default_backend postgres_slaves

backend postgres_master
    balance roundrobin
    option tcp-check
    tcp-check connect
    server postgres-master postgres-master:5432 check inter 5s

backend postgres_slaves
    balance roundrobin
    option tcp-check
    tcp-check connect
    server postgres-slave1 postgres-slave1:5432 check inter 5s
    server postgres-slave2 postgres-slave2:5432 check inter 5s</code></pre>

    <h3>Конфигурация nginx</h3>
    <div class="note">
        <strong>Настройки балансировки приложений:</strong>
        <ul>
            <li><strong>Алгоритм</strong>: least_conn (по наименьшему количеству подключений)</li>
            <li><strong>Upstream</strong>: app1:9000, app2:9000, app3:9000</li>
            <li><strong>Health checks</strong>: max_fails=3, fail_timeout=30s</li>
            <li><strong>Логирование</strong>: расширенный формат с upstream_addr и response_time</li>
        </ul>
    </div>

    <pre><code>upstream social_network_backend {
    least_conn;
    server app1:9000 max_fails=3 fail_timeout=30s;
    server app2:9000 max_fails=3 fail_timeout=30s;
    server app3:9000 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    server_name localhost;

    location / {
        proxy_pass http://social_network_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }
}</code></pre>


    <h2>Последовательность действий для запуска и тестирования</h2>

    <h3>1. Запуск системы</h3>
    <pre><code>cd lesson-09
./start_service.sh</code></pre>

    <h3>2. Тестирование системы</h3>
    <pre><code>./test_service.sh</code></pre>
    <p>Выполняет автоматически: базовое тестирование → детальное тестирование → тесты отказоустойчивости</p>

    <h3>3. Остановка системы</h3>
    <pre><code>./stop_service.sh</code></pre>
    <p>Полная очистка: удаляет все данные, контейнеры и сети</p>

    <h3>4. Мониторинг</h3>
    <ul>
        <li><strong>HAProxy статистика:</strong> http://localhost:8404/stats</li>
        <li><strong>Приложение:</strong> http://localhost/health</li>
        <li><strong>Docker логи:</strong> <code>docker logs lesson-09-[service-name]-1</code></li>
    </ul>


    

    

    <h2>Результаты тестирования</h2>

    <h3>Нагрузочное тестирование</h3>

    <h4>Этап 1: Создание тестовых пользователей</h4>
    <div class="note">
        <strong>Описание теста:</strong> Создание 50 тестовых пользователей для дальнейшего нагрузочного тестирования:
        <ul>
            <li><strong>Операция:</strong> POST /user/register</li>
            <li><strong>Количество пользователей:</strong> 50</li>
            <li><strong>Маршрутизация:</strong> Nginx → HAProxy → PostgreSQL мастер (порт 5000)</li>
            <li><strong>Retry логика:</strong> до 2 попыток при ошибках сервера</li>
            <li><strong>Параллелизм:</strong> до 5 одновременных запросов</li>
        </ul>
    </div>
    <div class="success">
        ✅ Результат: 50/50 пользователей создано (94.34% успешность с учетом retry), время выполнения 0.15 секунд
    </div>

    <h4>Этап 2: Тест чтения</h4>
    <div class="note">
        <strong>Описание теста:</strong> Выполнялись только операции чтения из слейвов PostgreSQL через HAProxy порт 5001:
        <ul>
            <li><strong>Получение профилей пользователей</strong> - GET /user/get/{id} с авторизацией</li>
            <li><strong>Поиск пользователей</strong> - GET /user/search?first_name=...&second_name=... с авторизацией</li>
            <li><strong>Распределение:</strong> случайный выбор операций с интервалом 0.1 сек</li>
            <li><strong>Параллелизм:</strong> до 20 одновременных запросов</li>
            <li><strong>Retry логика:</strong> до 3 попыток с увеличивающейся задержкой для компенсации репликационных задержек</li>
            <li><strong>Задержка синхронизации:</strong> 3 секунды после создания пользователей для синхронизации репликации</li>
        </ul>
    </div>
    <div class="success">
        ✅ Результат: 208/211 запросов успешно (98.58% успешность), производительность 8.2 RPS, среднее время отклика 0.012s
    </div>

    <h4>Этап 3: Смешанный тест</h4>
    <div class="note">
        <strong>Описание теста:</strong> Смешанная нагрузка с разделением операций чтения и записи:
        <ul>
            <li><strong>70% операций чтения:</strong> /user/get/{id}, /user/search (направляются на слейвы через порт 5001)</li>
            <li><strong>30% операций записи:</strong> /friend/set/{user_id}, /post/create (направляются на мастер через порт 5000)</li>
            <li><strong>Авторизация:</strong> все операции требуют токен авторизации</li>
            <li><strong>Параллелизм:</strong> до 20 одновременных запросов</li>
            <li><strong>Retry логика:</strong> обработка временных ошибок репликации</li>
            <li><strong>Задержка синхронизации:</strong> 2 секунды перед началом теста для синхронизации репликации</li>
        </ul>
    </div>
    <div class="success">
        ✅ Результат: 257/257 запросов успешно (100.00% успешность), производительность 11.1 RPS, среднее время отклика 0.012s
    </div>

    <h3>Тестирование отказоустойчивости</h3>

    <h4>Тест 1: Отказ PostgreSQL слейва</h4>
    <div class="success">
        <strong>РЕЗУЛЬТАТ: УСПЕХ</strong> - Отказ postgres-slave1 обработан корректно
    </div>
    
    <table>
        <tr>
            <th>Параметр</th>
            <th>До отказа</th>
            <th>После отказа</th>
            <th>После восстановления</th>
        </tr>
        <tr>
            <td>postgres-master</td>
            <td>✅ UP, 28 подключений</td>
            <td>✅ UP, 28 подключений</td>
            <td>✅ UP, 28 подключений</td>
        </tr>
        <tr>
            <td>postgres-slave1</td>
            <td>✅ UP, 27 подключений</td>
            <td>❌ DOWN (отказ)</td>
            <td>✅ UP, восстановлен</td>
        </tr>
        <tr>
            <td>postgres-slave2</td>
            <td>✅ UP, 26 подключений</td>
            <td>✅ UP, принял нагрузку</td>
            <td>✅ UP, 27 подключений</td>
        </tr>
    </table>

    <div class="note">
        <strong>Результат:</strong>
        <ul>
            <li>HAProxy обнаружил отказ slave1 за 5 секунд (health check interval)</li>
            <li>Трафик автоматически переключился на slave2</li>
            <li>Время недоступности: 0 секунд</li>
            <li>Slave1 восстановлен за 30 секунд и автоматически включен обратно</li>
            <li>Потеря запросов: 0</li>
        </ul>
    </div>

    <h2>Логи работы системы</h2>

    <h3>Расположение и назначение лог-файлов</h3>
    <table>
        <tr>
            <th>Компонент</th>
            <th>Команда просмотра логов</th>
            <th>Содержимая информация</th>
        </tr>
        <tr>
            <td><strong>Nginx</strong></td>
            <td><code>docker logs lesson-09-nginx-1</code></td>
            <td>HTTP запросы, балансировка upstream, статусы ответов, времена отклика</td>
        </tr>
        <tr>
            <td><strong>HAProxy</strong></td>
            <td><code>curl http://localhost:8404/stats</code></td>
            <td>Состояние backend серверов, статистика подключений, health checks</td>
        </tr>
        <tr>
            <td><strong>FastAPI Apps</strong></td>
            <td><code>docker logs lesson-09-app1-1</code><br/>
                <code>docker logs lesson-09-app2-1</code><br/>
                <code>docker logs lesson-09-app3-1</code></td>
            <td>API запросы, ошибки приложения, подключения к БД</td>
        </tr>
        <tr>
            <td><strong>PostgreSQL Master</strong></td>
            <td><code>docker logs lesson-09-postgres-master-1</code></td>
            <td>SQL запросы, репликация, подключения</td>
        </tr>
        <tr>
            <td><strong>PostgreSQL Slaves</strong></td>
            <td><code>docker logs lesson-09-postgres-slave1-1</code><br/>
                <code>docker logs lesson-09-postgres-slave2-1</code></td>
            <td>Streaming репликация, WAL recovery, standby status</td>
        </tr>
        <tr>
            <td><strong>Load Tests</strong></td>
            <td><code>cat test_results.log</code><br/>
                <code>cat system_logs_for_report.txt</code></td>
            <td>Результаты нагрузочного тестирования, метрики производительности</td>
        </tr>
    </table>

    <h3>Примеры ключевых логов</h3>

    <h4>Логи Nginx (балансировка приложений)</h4>
    <pre><code>127.0.0.1 - - [31/Jul/2025:11:59:41 +0000] "GET /health HTTP/1.1" 200 241 
    upstream_addr="172.18.0.9:9000" upstream_status="200" request_time="0.001"

127.0.0.1 - - [31/Jul/2025:11:59:51 +0000] "GET /health HTTP/1.1" 200 241 
    upstream_addr="172.18.0.8:9000" upstream_status="200" request_time="0.001"</code></pre>

    <h4>Логи тестирования отказоустойчивости</h4>
    <pre><code>Время теста: 2025-07-31 14:59:14 - 14:59:58

Исходное состояние HAProxy:
- postgres-master: UP, 28 подключений
- postgres-slave1: UP, 27 подключений  
- postgres-slave2: UP, 26 подключений

Событие: Отказ postgres-slave1 (docker kill)
[2025-07-31 14:59:22] Убиваем postgres-slave1...

Результат проверки:
[SUCCESS] Чтение из слейвов работает! HAProxy переключился на postgres-slave2

Финальное состояние HAProxy:
- postgres-master: UP, 28 подключений (без потерь)
- postgres-slave1: UP, восстановлен
- postgres-slave2: UP, 27 подключений (принял нагрузку)</code></pre>

    <h4>Логи нагрузочного тестирования</h4>
    <pre><code>2025-07-31 14:53:26,527 - INFO - Пользователей создано: 50/50
2025-07-31 14:53:26,527 - INFO - Время выполнения: 0.15 секунд
2025-07-31 14:53:26,527 - INFO - Процент успеха: 94.34%

2025-07-31 14:53:52,347 - INFO - Всего запросов: 211
2025-07-31 14:53:52,347 - INFO - Успешных: 208
2025-07-31 14:53:52,347 - INFO - Процент успеха: 98.58%
2025-07-31 14:53:52,347 - INFO - RPS: 8.2

2025-07-31 14:54:15,508 - INFO - Всего запросов: 257
2025-07-31 14:54:15,508 - INFO - Успешных: 257
2025-07-31 14:54:15,508 - INFO - Процент успеха: 100.00%
2025-07-31 14:54:15,508 - INFO - RPS: 11.1</code></pre>


    <h2>Выводы</h2>

    <div class="success">
        <h3>✅ Успешно реализовано:</h3>
        <ul>
            <li><strong>Отказоустойчивая архитектура</strong> с HAProxy и nginx балансировщиками</li>
            <li><strong>PostgreSQL репликация</strong> мастер + 2 слейва с автоматическим переключением</li>
            <li><strong>Горизонтальное масштабирование</strong> приложений (3 инстанса)</li>
            <li><strong>Автоматическое восстановление</strong> после отказов компонентов</li>
            <li><strong>Мониторинг</strong> через HAProxy stats и health checks</li>
            <li><strong>100% отказоустойчивость</strong> при отказе PostgreSQL slave</li>
            <li><strong>Полная автоматизация</strong> через готовые скрипты запуска, тестирования и остановки</li>
        </ul>
    </div>



    <h3>Соответствие требованиям задания</h3>
    
    <table>
        <tr>
            <th>Требование</th>
            <th>Статус</th>
            <th>Комментарий</th>
        </tr>
        <tr>
            <td>Поднять несколько слейвов PostgreSQL</td>
            <td><span class="improvement positive">✅ ВЫПОЛНЕНО</span></td>
            <td>2 слейва с репликацией</td>
        </tr>
        <tr>
            <td>Реализовать соединение через HAProxy</td>
            <td><span class="improvement positive">✅ ВЫПОЛНЕНО</span></td>
            <td>Порты 5000/5001 + статистика</td>
        </tr>
        <tr>
            <td>Поднять несколько приложений</td>
            <td><span class="improvement positive">✅ ВЫПОЛНЕНО</span></td>
            <td>3 инстанса FastAPI</td>
        </tr>
        <tr>
            <td>Балансировка через nginx</td>
            <td><span class="improvement positive">✅ ВЫПОЛНЕНО</span></td>
            <td>least_conn алгоритм</td>
        </tr>
        <tr>
            <td>Воспроизвести нагрузку</td>
            <td><span class="improvement positive">✅ ВЫПОЛНЕНО</span></td>
            <td>518 запросов за 3 этапа</td>
        </tr>
        <tr>
            <td>kill -9 слейва PostgreSQL</td>
            <td><span class="improvement positive">✅ ВЫПОЛНЕНО</span></td>
            <td>Система осталась работоспособной</td>
        </tr>
        <tr>
            <td>kill -9 инстанса бэкенда</td>
            <td><span class="improvement positive">✅ ВЫПОЛНЕНО</span></td>
            <td>nginx автоматически переключился</td>
        </tr>
        <tr>
            <td>Верная конфигурация HAProxy</td>
            <td><span class="improvement positive">✅ ВЫПОЛНЕНО</span></td>
            <td>TCP балансировка с health checks</td>
        </tr>
        <tr>
            <td>Верная конфигурация nginx</td>
            <td><span class="improvement positive">✅ ВЫПОЛНЕНО</span></td>
            <td>least_conn с мониторингом</td>
        </tr>
        <tr>
            <td>Логи работы системы</td>
            <td><span class="improvement positive">✅ ВЫПОЛНЕНО</span></td>
            <td>test_results.log + system_logs_for_report.txt + HAProxy stats + автоматизированные скрипты</td>
        </tr>
    </table>


</body>
</html> 