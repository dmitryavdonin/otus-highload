# Настройка кворумной репликации PostgreSQL

Эта директория содержит конфигурационные файлы и скрипты для настройки кластера PostgreSQL с кворумной синхронной репликацией. Конфигурация включает один мастер и три слейва, с требованием кворума от любых двух слейвов.

## Файлы

- `docker-compose-quorum-simple.yml` - Конфигурация Docker Compose для кластера PostgreSQL
- `init-master.sh` - Скрипт инициализации для мастер-узла
- `init-slave1.sh`, `init-slave2.sh`, `init-slave3.sh` - Скрипты инициализации для слейв-узлов
- `start_quorum_replication.sh` - Скрипт для запуска кластера репликации
- `check_quorum_replication.sh` - Скрипт для проверки статуса и функциональности репликации
- `stop_quorum_replication.sh` - Скрипт для остановки кластера репликации

## Использование

### Запуск кластера

Для запуска кластера PostgreSQL с кворумной репликацией:

```bash
./start_quorum_replication.sh
```

Этот скрипт выполнит:
1. Очистку существующих контейнеров и директорий данных
2. Создание новых директорий данных
3. Установку прав на выполнение для скриптов инициализации
4. Запуск кластера PostgreSQL
5. Ожидание готовности всех узлов

### Проверка статуса репликации

Для проверки статуса и функциональности кворумной репликации:

```bash
./check_quorum_replication.sh
```

Этот скрипт выполнит:
1. Проверку работы всех контейнеров
2. Проверку статуса репликации
3. Проверку конфигурации синхронной репликации
4. Вставку тестовых записей и проверку их репликации на все слейвы
5. Тестирование поведения кворума путем остановки одного слейва и проверки, что запись все еще успешно выполняется

### Остановка кластера

Для остановки кластера PostgreSQL с кворумной репликацией:

```bash
./stop_quorum_replication.sh
```

Этот скрипт остановит все контейнеры. Директории данных будут сохранены, если вы не удалите их вручную.

## Детали кворумной репликации

Кворумная синхронная репликация настроена со следующими параметрами:

- `synchronous_commit = on` - Обеспечивает синхронную фиксацию транзакций
- `synchronous_standby_names = 'ANY 2 (slave1, slave2, slave3)'` - Требует подтверждения от любых двух из трех слейвов

Эта конфигурация обеспечивает баланс между надежностью и производительностью, позволяя системе продолжать работу даже при отказе одного слейва.

## Тестирование отказоустойчивости

Скрипт `check_quorum_replication.sh` включает базовый тест поведения кворума путем остановки одного слейва и проверки, что запись все еще успешно выполняется. Для более комплексного тестирования можно сделать следующее:

1. Остановить мастер-узел: `docker stop pg-master`
2. Повысить один из слейвов до нового мастера: `docker exec -u postgres pg-slave1 pg_ctl promote -D /var/lib/postgresql/data`
3. Переконфигурировать оставшиеся слейвы для подключения к новому мастеру

