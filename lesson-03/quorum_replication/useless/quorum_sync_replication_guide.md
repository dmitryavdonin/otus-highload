# Руководство по настройке кворумной синхронной репликации PostgreSQL

## 1. Обзор

Кворумная синхронная репликация в PostgreSQL обеспечивает высокую надежность данных, гарантируя, что транзакции будут подтверждены только после того, как они будут записаны на определенное количество реплик. Это предотвращает потерю данных в случае сбоя мастера.

## 2. Настройка кворумной синхронной репликации

### 2.1. Конфигурация мастера

В файле `postgresql.conf` на мастере необходимо настроить следующие параметры:

```conf
# Базовые параметры репликации
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10
hot_standby = on

# Параметры синхронной репликации
synchronous_commit = on
synchronous_standby_names = 'ANY 2 (slave1, slave2, slave3)'
```

Параметр `synchronous_standby_names` настроен на кворумную репликацию, где:
- `ANY 2` - требуется подтверждение от любых 2 из 3 слейвов
- `(slave1, slave2, slave3)` - имена слейвов, которые участвуют в синхронной репликации

### 2.2. Конфигурация слейвов

На каждом слейве в файле `postgresql.auto.conf` должны быть настроены следующие параметры:

```conf
primary_conninfo = 'host=db-master port=5432 user=replicator password=replpass application_name=slave1'
hot_standby = on
```

Важно, чтобы `application_name` соответствовал имени, указанному в `synchronous_standby_names` на мастере.

## 3. Проверка работы синхронной репликации

### 3.1. Проверка статуса репликации на мастере

```sql
SELECT application_name, sync_state, sync_priority 
FROM pg_stat_replication;
```

Результат должен показывать, что слейвы находятся в состоянии `sync` или `potential`.

### 3.2. Проверка задержки транзакций

```sql
SELECT application_name, 
       pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS sent_lag,
       pg_wal_lsn_diff(pg_current_wal_lsn(), write_lsn) AS write_lag,
       pg_wal_lsn_diff(pg_current_wal_lsn(), flush_lsn) AS flush_lag,
       pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS replay_lag
FROM pg_stat_replication;
```

### 3.3. Тестирование кворума

Для проверки работы кворума можно остановить один из слейвов и убедиться, что транзакции все еще подтверждаются (так как требуется подтверждение от 2 из 3 слейвов).

```bash
docker-compose -f docker-compose-sync-replication.yml stop db-slave3
```

## 4. Преимущества кворумной синхронной репликации

1. **Высокая надежность данных**: Гарантирует, что данные сохранены как минимум на нескольких серверах.
2. **Отказоустойчивость**: Система продолжает работать даже при отказе одного из слейвов.
3. **Гибкость**: Можно настроить количество необходимых подтверждений в зависимости от требований к надежности и производительности.

## 5. Недостатки и ограничения

1. **Снижение производительности**: Синхронная репликация увеличивает время выполнения транзакций.
2. **Зависимость от сети**: Проблемы с сетью могут привести к задержкам или блокировке транзакций.
3. **Сложность настройки**: Требует более тщательной настройки и мониторинга.

## 6. Рекомендации по эксплуатации

1. **Мониторинг**: Регулярно проверяйте статус репликации и задержки.
2. **Тестирование отказоустойчивости**: Периодически проводите тесты с отключением слейвов.
3. **Балансировка нагрузки**: Распределяйте запросы на чтение между слейвами.
4. **Резервное копирование**: Несмотря на репликацию, регулярно делайте резервные копии.
